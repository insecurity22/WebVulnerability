import re
import requests
from bs4 import BeautifulSoup # beautifulsoup4
import sys

def help():
    print('Usage: ./send_getpacket url')
    sys.exit(1)

def getDomain(url, action_page):
    # Regex
    domainpattern = '^(https?:\/\/)?([\da-z\.-]+)'
    domain = re.compile(domainpattern).match(url).group()
    print("\nDomain = " + domain)

    middle = re.sub('^(https?:\/\/)', "", domain)
    print("Middle = " + middle)

    current_page_p = '\/[a-zA-Z0-9]*\.[a-zA-Z0-9]*$'
    current_page = re.compile(current_page_p).search(url).group()
    print("Current page = " + str(current_page))

    current_path = re.sub(current_page_p, "", url)
    print("Current path = " + current_path)

    if action_page == None: # for directorylisting
        return domain, middle, current_path
    else:
        next_url = current_path + '/' + action_page
        topost = re.sub(domainpattern, "", next_url)
        print("Next URL = " + next_url + "\nNext URL(Post) = " + topost)
        return domain, middle, next_url, topost


def getValues(url):

    # Get request
    r = requests.get(url).text
    soup = BeautifulSoup(r, 'html.parser')

    # Find next page, id and pw(transmit via POST method)
    form_tag = soup.form
    action_page = form_tag.get('action')

    id_value = soup.select('form input[type=text]')[0]['name']
    pw_value = soup.select('form input[type=password]')[0]['name']

    print(id_value, pw_value)
    print("\n[[[[[ GET ]]]]]]")
    print("Action page = " + action_page + "\nID = " + id_value + "\nPW = " + pw_value)

    return action_page, id_value, pw_value


if __name__ == '__main__':
    # execute only if run as a script

    if (len(sys.argv) != 2):
        help()

    # Send get packet
    url = str(sys.argv[1])
    action_page, id_value, pw_value = getValues(url)
    domain, middle, next_url, topost = getDomain(url, action_page)
